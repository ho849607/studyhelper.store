<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CKEditor + AI 실시간 추천 & 초안 작성</title>
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
    }
    #editor {
      border: 1px solid #ccc;
      min-height: 200px;
      padding: 10px;
    }
    /* 추천 단어 목록 스타일 */
    .suggestion-box {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 5px;
      z-index: 9999;
      display: none; /* 기본적으로 숨김 */
    }
    .suggestion-box div {
      padding: 5px 10px;
      cursor: pointer;
    }
    .suggestion-box div:hover {
      background-color: #eee;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>CKEditor + AI 실시간 추천</h1>
  <p>단어를 입력하면 람다(AI) 서버에서 추천 단어를 받아 표시합니다.  
  추천 단어 클릭 시, “초안 작성” 여부를 물어 AI 초안을 삽입합니다.</p>

  <!-- 에디터 영역 -->
  <div id="editor">여기에 문서를 작성하세요...</div>
  
  <!-- 추천 단어 박스 -->
  <div id="suggestionBox" class="suggestion-box"></div>

</div>

<script>
  let editorInstance;
  const suggestionBox = document.getElementById('suggestionBox');

  // 디바운스(300ms)로 AI 호출 횟수 제한
  let debounceTimer = null;
  function debounce(fn, delay) {
    return function(...args) {
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => fn(...args), delay);
    };
  }

  // 1) 에디터 초기화
  ClassicEditor
    .create(document.querySelector('#editor'))
    .then(editor => {
      editorInstance = editor;
      console.log("CKEditor 초기화 완료!");

      // 내용 변경 시 디바운스 호출
      editor.model.document.on('change:data', debounce(handleEditorChange, 300));
    })
    .catch(error => {
      console.error('CKEditor 초기화 실패:', error);
    });

  // 2) 에디터 내용 변경 → 람다(AI) 추천 호출
  async function handleEditorChange() {
    if (!editorInstance) return;

    // 현재 에디터 내용 (HTML)
    const htmlContent = editorInstance.getData();
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = htmlContent;
    const plainText = tempDiv.innerText || tempDiv.textContent || "";

    // 마지막 단어 추출 예시: 띄어쓰기나 마침표 등으로 분리
    const words = plainText.trim().split(/\s+/);
    if (words.length === 0) {
      hideSuggestions();
      return;
    }
    const lastWord = words[words.length - 1];
    if (lastWord.length === 0) {
      hideSuggestions();
      return;
    }

    console.log("마지막 단어:", lastWord);
    
    // 람다(AI)로 추천 요청
    try {
      // 예시: POST https://YOUR_LAMBDA_URL/autocomplete
      // body: { prefix: lastWord }
      const response = await fetch('https://YOUR_LAMBDA_URL/autocomplete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prefix: lastWord })
      });
      if (!response.ok) {
        throw new Error('추천 API 오류');
      }
      const data = await response.json();
      // data.suggestions 가 ["인공지능", "인도", ...] 형태라고 가정
      showSuggestions(data.suggestions || []);
    } catch (err) {
      console.error("추천 단어 호출 오류:", err);
      hideSuggestions();
    }
  }

  // 3) 추천 박스 표시
  function showSuggestions(suggestions) {
    if (!suggestions || suggestions.length === 0) {
      hideSuggestions();
      return;
    }
    
    suggestionBox.innerHTML = '';
    suggestions.forEach(item => {
      const div = document.createElement('div');
      div.textContent = item;
      div.addEventListener('click', () => onSuggestionClick(item));
      suggestionBox.appendChild(div);
    });

    // 박스 위치(데모)
    suggestionBox.style.left = '200px';
    suggestionBox.style.top = '300px';
    suggestionBox.style.display = 'block';
  }

  function hideSuggestions() {
    suggestionBox.style.display = 'none';
  }

  // 4) 추천 단어 클릭 시 → AI 초안 생성
  async function onSuggestionClick(word) {
    hideSuggestions();

    const ok = confirm(`"${word}" 주제에 대한 AI 초안을 작성할까요?`);
    if (!ok) return;

    try {
      // 실제 API 예시: POST /draft
      // body: { topic: word }
      const res = await fetch('https://YOUR_LAMBDA_URL/draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic: word })
      });
      if (!res.ok) {
        throw new Error('초안 생성 API 오류');
      }
      const data = await res.json();
      // data.draft: "주제 "xxx" 초안\n- 1...\n- 2..."
      const draftContent = data.draft || `주제 "${word}" 초안이 없습니다.`;

      // 에디터에 초안 삽입
      const currentHtml = editorInstance.getData();
      const newHtml = currentHtml + `<p style="color:blue;">[AI 초안] ${draftContent.replace(/\n/g, '<br>')}</p>`;
      editorInstance.setData(newHtml);

      alert(`"${word}" 주제에 대한 초안이 추가되었습니다.`);
    } catch (err) {
      console.error(err);
      alert("초안 생성 중 오류 발생: " + err);
    }
  }
</script>
</body>
</html>
